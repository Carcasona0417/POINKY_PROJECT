<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pig Details - Poinky</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* WRAPPER */
body {
    margin: 0;
    font-family: "Poppins", sans-serif;
}

/* MAIN LAYOUT */
.pig-details-wrapper {
    display: flex;
    gap: 20px;
    background: white;
    padding: 25px;
    border-radius: 14px;
    border: 2px solid #f3a4a4;
    max-width: 1100px;
}

/* LEFT PANEL */
.left-panel {
    width: 35%;
    background: #FFE4E8;
    padding: 22px;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.left-header {
    display: flex;
    align-items: center;
    gap: 15px;
    position: relative;
    color: #F08080;
}

.pig-icon {
    width: 45px;
}

.actions {
    margin-left: auto;
    position: relative;
}

.actions-icon {
    cursor: pointer;
    font-size: 20px;
}

/* DROPDOWN */
.actions-dropdown {
    position: absolute;
    right: 0;
    top: 120%;
    background: white;
    border-radius: 8px;
    border: 1px solid #ffcbcb;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    display: none;
    overflow: hidden;
    width: 150px;
    z-index: 10;
}

.actions-dropdown button {
    width: 100%;
    padding: 10px 15px;
    border: none;
    background: white;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    cursor: pointer;
}

.actions-dropdown button:hover {
    background: #ffecef;
}

.actions-dropdown .delete {
    color: #d32f2f;
}

/* LEFT INFO ITEMS */
.info-item {
    display: flex;
    justify-content: space-between;
    border-bottom: 1px solid #f1b4b4;
    padding-bottom: 5px;
}

.info-item label {
    font-size: 14px;
    color: #555;
}

.info-item span {
    font-weight: 600;
    color: #F08080;
}

/* RIGHT PANEL */
.right-panel {
    width: 65%;
    background: white;
    padding: 20px;
    border-radius: 14px;
    border: 2px solid #f3bcbc;
    display: flex;
    flex-direction: column;
}

/* TAB BUTTONS */
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.tab-btn {
    width: 60px;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #ffd0d5;
    background: #ffecef;
    color: #F08080;
    font-size: 18px;
    cursor: pointer;
    transition: 0.2s;
}

.tab-btn.active {
    background: #F16877;
    color: white;
    border-color: #F08080;
}

/* TAB CONTENT */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.tab-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
}

.tab-header h4 {
    color: #F08080;
    margin: 0;
}

.add-btn {
    background: #E74A5A;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 13px;
    font-family: "Poppins", sans-serif;
    font-weight: 500; 
}


.add-btn:hover {
    background: #BE4040;
    
}

/* Disabled button appearance */
.add-btn:disabled,
#btnEditPig:disabled,
.actions-dropdown button:disabled {
    background: #ddd !important;
    color: #999 !important;
    cursor: not-allowed !important;
    opacity: 0.7;
    pointer-events: none;
}

/* TABLES */
.records-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #444;
    border-radius: 8px;
    overflow: hidden;
    
}

.records-table th {
    background: #FFA2AB;
    color: #413F3F;
    padding: 10px;
    text-align: center;
    font-weight: 600;
}

.records-table td {
    padding: 10px;
    text-align: center;
    border-top: 1px solid #e7e7e7;
}

.empty-row {
    text-align: center;
    font-style: italic;
    color: #999;
}

    .pig-thumb {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ddd;
    cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.12s ease;
}

.pig-thumb:hover { transform: scale(1.06); box-shadow: 0 6px 18px rgba(0,0,0,0.12); }

    /* IMAGE VIEWER */
    .img-viewer-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.75);
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .img-viewer-content {
        position: relative;
        max-width: 95%;
        max-height: 95%;
        padding: 8px;
    }

    .img-viewer-img {
        width: 100%;
        height: auto;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        background: #fff;
        display: block;
    }

    /* Close should sit at the upper-right of the overlay */
    .img-viewer-close {
        position: absolute;
        top: 18px;
        right: 18px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: #fff;
        color: #333;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10001;
    }

/* ACTION BUTTONS */
.action-btn {
    padding: 4px 8px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: "Poppins", sans-serif;
    transition: 0.2s;
    margin: 0 4px;
}

.action-btn-edit {
    color: #2E7D32;
}

.action-btn-edit:hover {
    opacity: 0.7;
    transform: scale(1.1);
}

.action-btn-delete {
    color: #C62828;
}

.action-btn-delete:hover {
    opacity: 0.7;
    transform: scale(1.1);
}

.action-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
}

/* RESPONSIVE */
@media (max-width: 900px) {
    .pig-details-wrapper {
        flex-direction: column;
    }
    .left-panel, .right-panel {
        width: 100%;
    }
}
</style>

</head>
<body>

<div class="pig-details-wrapper">

    <!-- LEFT SIDE -->
    <div class="left-panel">

        <div class="left-header">
            <img src="assets/dash-icons/Pig.png" alt="Pig Icon" class="pig-icon">
            <h3>Pig Details</h3>

            <div class="actions">
                <i class="fas fa-ellipsis-v actions-icon" id="detailsOptionsBtn"></i>

                <div class="actions-dropdown" id="detailsDropdown">
                    <button id="btnEditPig"><i class="fas fa-edit"></i> Edit Pig</button>
                    <button id="btnDeletePig" class="delete"><i class="fas fa-trash-alt"></i> Delete Pig</button>
                </div>
            </div>
        </div>

        <div class="info-item"><label>Pig ID:</label><span id="pd-name">-</span></div>
        <div class="info-item"><label>Breed:</label><span id="pd-breed">-</span></div>
        <div class="info-item"><label>Gender:</label><span id="pd-gender">-</span></div>
        <div class="info-item"><label>Date Acquired:</label><span id="pd-date">-</span></div>
        <div class="info-item"><label>Initial Weight:</label><span id="pd-iw">-</span></div>
        <div class="info-item"><label>Current Weight:</label><span id="pd-cw">-</span></div>
        <div class="info-item"><label>Status:</label><span id="pd-status">-</span></div>

    </div>

    <!-- RIGHT SIDE -->
    <div class="right-panel">

        <!-- TAB BUTTONS -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="weight"><i class="fa-solid fa-scale-balanced"></i></button>
            <button class="tab-btn" data-tab="expenses"><i class="fa-solid fa-book-open"></i></button>
            <button class="tab-btn" data-tab="health"><i class="fa-solid fa-syringe"></i></button>
        </div>

        <!-- TAB: WEIGHT -->
        <div class="tab-content active" id="tab-weight">
            <div class="tab-header">
                <h4>Weight Records</h4>
                <button class="add-btn" id="btnAddWeight">
                    <i class="fa-solid fa-plus"></i> Add Weight
                </button>
            </div>

            <table class="records-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Weight</th>
                        <th>Picture</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="weightBody"></tbody>
            </table>
        </div>

        <!-- TAB: EXPENSES -->
        <div class="tab-content" id="tab-expenses">
            <div class="tab-header">
                <h4>Expenses Records</h4>
                <button class="add-btn" id="btnAddExpense">
                    <i class="fa-solid fa-plus"></i> Add Expense
                </button>
            </div>

            <table class="records-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Expense</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="expenseBody"></tbody>
            </table>
        </div>

        <!-- TAB: HEALTH -->
        <div class="tab-content" id="tab-health">
            <div class="tab-header">
                <h4>Vaccination Records</h4>
                <button class="add-btn" id="btnAddVaccine">
                    <i class="fa-solid fa-plus"></i> Add Vaccine
                </button>
            </div>
            <table class="records-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Due Date</th>
                        <th>Vaccine</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="healthBody"></tbody>
            </table>
        </div>

    </div>

</div>

<script>
// =======================================
// TAB SWITCHING
// =======================================
document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
        // If weight tab opened, lazy-load weight history
        if (btn.dataset.tab === 'weight') {
            try { fetchWeightHistory(); } catch (e) { console.warn('fetchWeightHistory error', e); }
        }
    });
});

// =======================================
// DROPDOWN
// =======================================
const optionsBtn = document.getElementById("detailsOptionsBtn");
const dropdown = document.getElementById("detailsDropdown");

optionsBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
});

document.addEventListener("click", () => dropdown.style.display = "none");

// =======================================
// DATA + PARENT COMMUNICATION
// =======================================
(function () {

    const params = new URLSearchParams(window.location.search);
    const pigId  = params.get("id");
    const farmId = params.get("farm");

    const nameEl   = document.getElementById("pd-name");
    const breedEl  = document.getElementById("pd-breed");
    const genderEl = document.getElementById("pd-gender");
    const dateEl   = document.getElementById("pd-date");
    const iwEl     = document.getElementById("pd-iw");
    const cwEl     = document.getElementById("pd-cw");
    const statusEl = document.getElementById("pd-status");

    const weightBody  = document.getElementById("weightBody");
    const expenseBody = document.getElementById("expenseBody");
    const healthBody  = document.getElementById("healthBody");

    const btnAddWeight  = document.getElementById("btnAddWeight");
    const btnAddExpense = document.getElementById("btnAddExpense");
    const btnAddVaccine = document.getElementById("btnAddVaccine");
    const btnEditPig    = document.getElementById("btnEditPig");

    let pigLoadedFromMessage = false;
    let weightLoaded = false; // prevent duplicate fetches
    let vaccinationLoaded = false; // prevent fallback overwrite when server data loaded

    // =======================================================
    // CALL PARENT ACTION SAFE (TRY DIRECT → FALLBACK POSTMESSAGE)
    // =======================================================
    function callParentAction(label, fnName, data) {

        // Use postMessage as the primary transport to notify the parent window.
        // Directly invoking parent functions can fail due to scoping or timing
        // differences; postMessage is consistent across embedding scenarios.
        try {
            window.parent.postMessage({ type: "openAction", action: fnName, pigId, farmId, data }, "*");
            return;
        } catch (postErr) {
            console.warn('postMessage to parent failed, falling back to direct call', postErr);
        }

        // Fallback: attempt direct call if postMessage is unavailable for some reason
        try {
            if (window.parent && typeof window.parent[fnName] === 'function') {
                window.parent[fnName](pigId, farmId, data);
                return;
            }
        } catch (directErr) {
            console.warn('Direct call fallback failed for', fnName, directErr);
        }

        console.warn('callParentAction: unable to notify parent for', fnName);
    }

    // Expose `callParentAction` to the global/window scope so
    // functions defined in the global scope (e.g. `editWeightRecord`)
    // can call it directly when `postMessage` fallback isn't used.
    try { window.callParentAction = callParentAction; } catch (e) { /* noop if not allowed */ }

    // =======================================================
    // BUTTON HANDLERS
    // =======================================================
    btnAddWeight.addEventListener("click", () => {
        callParentAction("Add Weight", "openAddWeightFromDetails");
    });

    btnAddExpense.addEventListener("click", () => {
        callParentAction("Add Expense", "openAddExpenseFromDetails");
    });

    btnAddVaccine.addEventListener("click", () => {
        callParentAction("Add Vaccination", "openAddVaccinationFromDetails");
    });

        // DELETE PIG — ask parent to open delete-pig confirmation
        const btnDeletePigEl = document.getElementById('btnDeletePig');
        if (btnDeletePigEl) {
            btnDeletePigEl.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.style.display = "none";
                callParentAction('Delete Pig', 'openDeletePigFromDetails');
            });
        }

    // ⭐ NEW: EDIT PIG
    if (btnEditPig) {
        btnEditPig.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown.style.display = "none";
            callParentAction("Edit Pig", "openEditPigDetailsFromDetails");
        });
    }

    // =======================================================
    // RECEIVE pigData FROM PARENT
    // =======================================================
    window.addEventListener("message", (ev) => {
        const data = ev.data;
        if (!data || data.type !== "pigData") return;
        pigLoadedFromMessage = true;
        // Reset weightLoaded flag so we fetch fresh data from backend
        weightLoaded = false;
        renderPig(data.pig);
    });

    function formatStatus(s) {
        return {
            growing: "Growing",
            tosale: "To Sale",
            sold: "Sold",
            deceased: "Deceased"
        }[s] || s;
    }

    function formatDateDisplay(dateStr) {
        if (!dateStr) return "-";
        try {
            const date = new Date(dateStr);
            return new Intl.DateTimeFormat("en-US", { 
                year: "numeric", 
                month: "short", 
                day: "2-digit" 
            }).format(date);
        } catch (e) {
            return dateStr;
        }
    }

    function emptyRow(body, cols, msg) {
        body.innerHTML = `<tr><td colspan="${cols}" class="empty-row">${msg}</td></tr>`;
    }

    // =======================================================
    // RENDER PIG DATA
    // =======================================================
    async function renderPig(pig) {
        nameEl.textContent   = pig.name;
        breedEl.textContent  = pig.breed;
        genderEl.textContent = pig.gender;
        dateEl.textContent   = formatDateDisplay(pig.date);

        // Initial values (may be updated after fetching server weight history)
        iwEl.textContent = pig.weightHistory?.[0]?.weight
            ? pig.weightHistory[0].weight + " kg" : "-";

        cwEl.textContent = pig.weight ? pig.weight : "-";
        statusEl.textContent = formatStatus(pig.status);

        // Disable add/edit buttons for pigs that are already sold or deceased
        const isInactive = pig.status === 'sold' || pig.status === 'deceased';
        if (btnAddWeight) {
            btnAddWeight.disabled = isInactive;
            btnAddWeight.title = isInactive ? 'Cannot add weight to sold/deceased pig' : '';
        }
        if (btnAddExpense) {
            btnAddExpense.disabled = isInactive;
            btnAddExpense.title = isInactive ? 'Cannot add expenses to sold/deceased pig' : '';
        }
        if (btnAddVaccine) {
            btnAddVaccine.disabled = isInactive;
            btnAddVaccine.title = isInactive ? 'Cannot add vaccination to sold/deceased pig' : '';
        }
        if (btnEditPig) {
            btnEditPig.disabled = isInactive;
            btnEditPig.title = isInactive ? 'Cannot edit details of sold/deceased pig' : '';
        }

        // WEIGHT TABLE
        // Render weight table using existing pig.weightHistory (may be placeholder)
        renderWeightSection(pig);

        // Attempt to fetch authoritative weight history from server after rendering.
        // Await it here so we have a clear stack and can handle errors synchronously.
        try {
            await fetchWeightHistory();
        } catch (e) {
            console.warn('fetchWeightHistory failed', e);
        }
        // Attempt to fetch vaccination history from backend and render
        try {
            await fetchVaccinationHistory();
        } catch (e) {
            console.warn('fetchVaccinationHistory failed', e);
        }


    // Render weight UI section (initial + table) from a pig-like object with weightHistory
    function renderWeightSection(pig) {
        weightBody.innerHTML = "";
        if (!pig.weightHistory?.length) {
            emptyRow(weightBody, 4, "No weight records.");
            iwEl.textContent = "-";
            cwEl.textContent = pig.weight ? pig.weight : "-";
            return;
        }

        // Initial weight is first record
        iwEl.textContent = pig.weightHistory[0].weight ? pig.weightHistory[0].weight + ' kg' : '-';

        // Current weight is latest record
        const latest = pig.weightHistory[pig.weightHistory.length - 1];
        cwEl.textContent = latest && latest.weight ? `${latest.weight} kg` : (pig.weight ? pig.weight : '-');

        [...pig.weightHistory].slice().reverse().forEach((rec, idx) => {
            const actualIndex = pig.weightHistory.length - 1 - idx;
            weightBody.innerHTML += `
                <tr>
                    <td>${rec.date}</td>
                    <td>${rec.weight} kg</td>
                    <td><img src="${rec.img || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22%3E%3C/svg%3E'}" class="pig-thumb" onclick="openImageViewer(this.src)" onerror="this.style.display='none'"></td>
                    <td>
                        <button class="action-btn action-btn-edit" onclick="editWeightRecord(${actualIndex})" title="Edit" aria-label="Edit weight" ${pig.status === 'sold' || pig.status === 'deceased' ? 'disabled' : ''}>
                            <i class="fas fa-edit" aria-hidden="true"></i>
                        </button>
                        <button class="action-btn action-btn-delete" onclick="deleteWeightRecord(${actualIndex})" title="Delete" aria-label="Delete weight">
                            <i class="fas fa-trash" aria-hidden="true"></i>
                        </button>
                    </td>
                </tr>`;
        });
    }

    // Fetch weight history from backend for current pig and render
    async function fetchWeightHistory() {
        if (weightLoaded) return;
        try {
            console.log('fetchWeightHistory: starting for pigId:', pigId);
            // Try multiple candidate API bases in order: parent origin, page origin, fallback localhost:8080.
            // This avoids calling a static dev server (e.g. Live Server on :5501) which doesn't expose /api.
            let candidates = [];
            let parentOrigin = null;
            try {
                parentOrigin = window.parent && window.parent.location && window.parent.location.origin;
                if (parentOrigin && parentOrigin !== 'null') candidates.push(parentOrigin);
            } catch (e) { parentOrigin = null; }
            let pageOrigin = null;
            try {
                pageOrigin = (window.location && window.location.origin && window.location.origin !== 'null') ? window.location.origin : null;
                if (pageOrigin) candidates.push(pageOrigin);
            } catch (e) { pageOrigin = null; }
            // default backend fallback
            const backendFallback = 'http://localhost:8080';
            candidates.push(backendFallback);
            // dedupe while preserving order
            candidates = candidates.filter((v,i,a) => a.indexOf(v) === i);
            // If page is served by a Live Server (common ports 5500/5501), prefer the backendFallback first
            const isLiveServer = pageOrigin && (pageOrigin.includes(':5500') || pageOrigin.includes(':5501'));
            if (isLiveServer) {
                candidates = candidates.filter(c => c !== backendFallback);
                candidates.unshift(backendFallback);
            }
            console.debug('fetchWeightHistory: API candidates', candidates);

            let res = null;
            let usedBase = null;
            for (const base of candidates) {
                const url = `${base.replace(/\/$/, '')}/api/pigs/${encodeURIComponent(pigId)}/weights`;
                try {
                    // attempt fetch; if it fails or returns non-ok, try next candidate
                    console.log('fetchWeightHistory: trying URL:', url);
                    const attempt = await fetch(url, { method: 'GET' });
                    if (attempt && attempt.ok) {
                        res = attempt;
                        usedBase = base;
                        console.log('fetchWeightHistory: success with', usedBase);
                        break;
                    } else {
                        // log non-ok status and continue
                        console.debug('fetchWeightHistory: %s responded %s', url, attempt.status);
                    }
                } catch (err) {
                    // network/CORS error — try next candidate
                    console.debug('fetchWeightHistory: failed to reach %s — %o', url, err && err.message);
                }
            }
            if (!res) throw new Error('Failed to fetch weight history from any API base');
            const data = await res.json();
            console.log('fetchWeightHistory: got data:', data);
            console.debug('fetchWeightHistory: using API base', usedBase, data && data.success ? 'success' : 'no-data');
            if (data && data.success) {
                // Normalize: data.weightHistory is expected array
                const ph = { weightHistory: data.weightHistory || [], weight: null, status: null };

                // Prefer authoritative currentWeight returned by the API (latest from weight_records)
                if (data.currentWeight !== undefined && data.currentWeight !== null) {
                    ph.weight = `${data.currentWeight} kg`;
                }

                // If API didn't provide currentWeight, derive it from returned weightHistory
                if (ph.weightHistory.length > 0) {
                    const latest = ph.weightHistory[ph.weightHistory.length - 1];
                    if (ph.weight === null) ph.weight = latest.weight ? `${latest.weight} kg` : null;
                } else if (data.initialWeight !== null && data.initialWeight !== undefined) {
                    ph.weightHistory = [{ date: null, weight: data.initialWeight, img: null }];
                    if (ph.weight === null) ph.weight = `${data.initialWeight} kg`;
                }

                console.log('fetchWeightHistory: about to render with:', ph);
                renderWeightSection(ph);
                // mark loaded only after successful render
                weightLoaded = true;
            }
        } catch (err) {
            console.warn('fetchWeightHistory error', err);
        }
    }
        // EXPENSES TABLE
        expenseBody.innerHTML = "";
        if (!pig.expenses?.length) {
            emptyRow(expenseBody, 4, "No expenses.");
        } else {
            pig.expenses.forEach((exp, idx) => {
                expenseBody.innerHTML += `
                    <tr>
                        <td>${exp.date}</td>
                        <td>₱${exp.price}</td>
                        <td>${exp.category || '-'}</td>
                        <td>
                            <button class="action-btn action-btn-edit" onclick="editExpenseRecord(${idx})" title="Edit" aria-label="Edit expense" ${isInactive ? 'disabled' : ''}>
                                <i class="fas fa-edit" aria-hidden="true"></i>
                            </button>
                            <button class="action-btn action-btn-delete" onclick="deleteExpenseRecord(${idx})" title="Delete" aria-label="Delete expense">
                                <i class="fas fa-trash" aria-hidden="true"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        }

        // VACCINES: rendered by fetchVaccinationHistory (server) or fallback to parent data
        // If parent provided `pig.vaccinations` we will still render that as a fallback
        // Only run this fallback if server data DID NOT load (vaccinationLoaded=false)
        if (!vaccinationLoaded) {
            healthBody.innerHTML = "";
            if (!pig.vaccinations?.length) {
                emptyRow(healthBody, 5, "No vaccination records.");
            } else {
                pig.vaccinations.forEach((v, idx) => {
                    healthBody.innerHTML += `
                        <tr>
                            <td>${v.date || v.createdAt || '-'}</td>
                            <td>${v.dueDate || v.DueDate || '-'}</td>
                            <td>${v.type || v.Category || v.category || '-'}</td>
                            <td>${formatStatus(v.status || '-')}</td>
                            <td>
                                <button class="action-btn action-btn-edit" onclick="editVaccinationRecord(${idx})" title="Edit" aria-label="Edit vaccination" ${isInactive ? 'disabled' : ''}>
                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                </button>
                                <button class="action-btn action-btn-delete" onclick="deleteVaccinationRecord(${idx})" title="Delete" aria-label="Delete vaccination">
                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                </button>
                            </td>
                        </tr>`;
                });
            }
        }

    // Fetch vaccination history from backend (tries multiple API bases)
    async function fetchVaccinationHistory() {
        try {
            const candidates = getApiBase();
            let res = null;
            let usedBase = null;

            // Build query params (include both camel and Pascal cases to match backend)
            const params = new URLSearchParams();
            if (pigId) {
                params.set('pigId', pigId);
                params.set('PigID', pigId);
            }
            console.debug('fetchVaccinationHistory: pigId', pigId, 'API candidates', candidates);

            for (const base of candidates) {
                const url = `${base.replace(/\/$/, '')}/api/vaccinations/get-vaccinations?${params.toString()}`;
                try {
                    console.debug('fetchVaccinationHistory: trying URL:', url);
                    const attempt = await fetch(url, { method: 'GET' });
                    if (attempt && attempt.ok) {
                        res = attempt;
                        usedBase = base;
                        break;
                    } else {
                        console.debug('fetchVaccinationHistory: non-ok response', url, attempt && attempt.status);
                    }
                } catch (err) {
                    console.debug('fetchVaccinationHistory: failed to reach', url, err && err.message);
                }
            }

            if (!res) throw new Error('Failed to fetch vaccination records from any API base');
            const data = await res.json();
            console.debug('fetchVaccinationHistory: response from server', usedBase, data);
            if (!data) return;
            const records = (data.records && Array.isArray(data.records)) ? data.records : (Array.isArray(data) ? data : []);
            if (data && data.success === false) console.warn('fetchVaccinationHistory: server reported failure', data.message || data.error || data);

            // Normalize and render
            healthBody.innerHTML = '';
            if (!records.length) {
                emptyRow(healthBody, 5, 'No vaccination records.');
                vaccinationLoaded = true; // mark as attempted so fallback won't overwrite
                return;
            }

            records.forEach((r, idx) => {
                const date = r.Date || r.date || r.createdAt || '-';
                const dueDate = r.DueDate || r.dueDate || '-';
                const type = r.Category || r.category || r.type || '-';
                // Force display status as Scheduled for server-returned records
                const status = 'Scheduled';
                healthBody.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${dueDate}</td>
                        <td>${type}</td>
                        <td>${status}</td>
                        <td>
                            <button class="action-btn action-btn-edit" onclick="editVaccinationRecord(${idx})" title="Edit" aria-label="Edit vaccination" ${isInactive ? 'disabled' : ''}>
                                <i class="fas fa-edit" aria-hidden="true"></i>
                            </button>
                            <button class="action-btn action-btn-delete" onclick="deleteVaccinationRecord(${idx})" title="Delete" aria-label="Delete vaccination">
                                <i class="fas fa-trash" aria-hidden="true"></i>
                            </button>
                        </td>
                    </tr>`;
            });
            vaccinationLoaded = true;

        } catch (err) {
            console.warn('fetchVaccinationHistory error', err);
        }
    }
    }

    // =======================================================
    // INITIAL: TRY DIRECT READ FROM PARENT
    // =======================================================
    function tryLoad(attempt=1) {
        if (pigLoadedFromMessage) return;

        try {
            if (window.parent && typeof window.parent.getPigDataById === "function") {
                const pig = window.parent.getPigDataById(pigId, farmId);
                if (pig) return renderPig(pig);
            }
        } catch (err) {}

        if (attempt < 10) setTimeout(()=> tryLoad(attempt+1), 150);
    }

    tryLoad();
})();

// =======================================
// EDIT/DELETE HANDLERS (global scope)
// =======================================

// Get API base URL helper
function getApiBase() {
    let candidates = [];
    let parentOrigin = null;
    try {
        parentOrigin = window.parent && window.parent.location && window.parent.location.origin;
        if (parentOrigin && parentOrigin !== 'null') candidates.push(parentOrigin);
    } catch (e) { parentOrigin = null; }
    let pageOrigin = null;
    try {
        pageOrigin = (window.location && window.location.origin && window.location.origin !== 'null') ? window.location.origin : null;
        if (pageOrigin) candidates.push(pageOrigin);
    } catch (e) { pageOrigin = null; }
    const backendFallback = 'http://localhost:8080';
    candidates.push(backendFallback);
    candidates = candidates.filter((v,i,a) => a.indexOf(v) === i);
    const isLiveServer = pageOrigin && (pageOrigin.includes(':5500') || pageOrigin.includes(':5501'));
    if (isLiveServer) {
        candidates = candidates.filter(c => c !== backendFallback);
        candidates.unshift(backendFallback);
    }
    return candidates;
}

// Show notification helper
function showNotification(type, message) {
    // Create a simple notification div if one doesn't exist
    let notif = document.getElementById('weightNotification');
    if (!notif) {
        notif = document.createElement('div');
        notif.id = 'weightNotification';
        notif.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            font-family: "Poppins", sans-serif;
            z-index: 10000;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        `;
        document.body.appendChild(notif);
    }
    
    notif.textContent = message;
    notif.style.background = type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#ff9800';
    notif.style.color = 'white';
    notif.style.display = 'block';
    
    setTimeout(() => {
        notif.style.display = 'none';
    }, 3000);
}

// WEIGHT RECORD HANDLERS with API integration
window.editWeightRecord = function(index) {
    console.log('editWeightRecord called with index:', index);
    const params = new URLSearchParams(window.location.search);
    const pigId = params.get("id");
    const farmId = params.get("farm");
    
    console.log('pigId:', pigId, 'farmId:', farmId);
    
    // Still call parent for modal UI, but we'll hook into the submit handler
    console.log('Calling callParentAction for edit weight');
    callParentAction("Edit Weight", "openEditWeightFromDetails", { index });
};

window.deleteWeightRecord = async function(index) {
    console.log('deleteWeightRecord called with index:', index);
    const params = new URLSearchParams(window.location.search);
    const pigId = params.get("id");
    const farmId = params.get("farm");
    
    console.log('pigId:', pigId, 'farmId:', farmId);
    
    if (!pigId) {
        showNotification('error', 'Pig ID not found');
        return;
    }

    // Get the weight record details from the current pig data
    try {
        // Try to get from parent first
        let pig = null;
        try {
            if (window.parent && typeof window.parent.getPigDataById === 'function') {
                pig = window.parent.getPigDataById(pigId, farmId);
                console.log('Got pig from parent:', pig ? 'yes' : 'no');
            }
        } catch (e) {
            console.warn('Error getting pig from parent:', e);
        }

        if (!pig || !pig.weightHistory || !pig.weightHistory[index]) {
            showNotification('error', 'Weight record not found');
            return;
        }

        const record = pig.weightHistory[index];
        
        // Confirm deletion
        if (!confirm(`Delete weight record from ${record.date}? This action cannot be undone.`)) {
            return;
        }

        // Call parent to handle deletion via the delete record modal
        // This will trigger the pendingDeleteData flow which calls the backend API
        console.log('Calling parent openDeleteRecordConfirmModal');
        if (window.parent && typeof window.parent.openDeleteRecordConfirmModal === 'function') {
            console.log('Calling parent function directly');
            window.parent.openDeleteRecordConfirmModal("weight", pigId, farmId, index);
        } else {
            // Fallback: use postMessage
            console.log('Using postMessage fallback');
            callParentAction("Delete Weight", "openDeleteRecordConfirmModal", { type: "weight", index });
        }
        
    } catch (err) {
        console.warn('deleteWeightRecord error:', err);
        showNotification('error', 'Failed to delete weight record');
    }
};

// EXPENSE RECORD HANDLERS
// EXPENSE RECORD HANDLERS
window.editExpenseRecord = function(index) {
    console.log('editExpenseRecord called with index:', index);
    const params = new URLSearchParams(window.location.search);
    const pigId = params.get("id");
    const farmId = params.get("farm");
    console.log('pigId:', pigId, 'farmId:', farmId);
    // Try to notify parent via the `recordAction` channel (Farm.js listens on this)
    try {
        window.parent.postMessage({ type: 'recordAction', action: 'openEditExpenseFromDetails', pigId, farmId, data: { index } }, "*");
        return;
    } catch (postErr) {
        console.warn('postMessage recordAction failed for editExpense, falling back', postErr);
    }

    // Fallback: direct call if available
    try {
        if (window.parent && typeof window.parent.openEditExpenseFromDetails === 'function') {
            window.parent.openEditExpenseFromDetails(pigId, farmId, { index });
            return;
        }
    } catch (directErr) {
        console.warn('Direct call fallback failed for openEditExpenseFromDetails', directErr);
    }

    // Last resort: use generic callParentAction (openAction channel)
    callParentAction("Edit Expense", "openEditExpenseFromDetails", { index });
};

window.deleteExpenseRecord = async function(index) {
    console.log('deleteExpenseRecord called with index:', index);
    const params = new URLSearchParams(window.location.search);
    const pigId = params.get("id");
    const farmId = params.get("farm");

    console.log('pigId:', pigId, 'farmId:', farmId);

    if (!pigId) {
        showNotification('error', 'Pig ID not found');
        return;
    }

    try {
        let pig = null;
        try {
            if (window.parent && typeof window.parent.getPigDataById === 'function') {
                pig = window.parent.getPigDataById(pigId, farmId);
                console.log('Got pig from parent:', pig ? 'yes' : 'no');
            }
        } catch (e) {
            console.warn('Error getting pig from parent:', e);
        }

        if (!pig || !pig.expenses || !pig.expenses[index]) {
            showNotification('error', 'Expense record not found');
            return;
        }

        const record = pig.expenses[index];

        if (!confirm(`Delete expense record on ${record.date || 'unknown date'}? This action cannot be undone.`)) {
            return;
        }

        // Prefer generic delete modal on parent if available
        if (window.parent && typeof window.parent.openDeleteRecordConfirmModal === 'function') {
            window.parent.openDeleteRecordConfirmModal('expense', pigId, farmId, index);
        } else {
            // Fallback to existing confirmDeleteExpense handler via postMessage/direct call
            callParentAction("Delete Expense", "confirmDeleteExpense", { index });
        }

    } catch (err) {
        console.warn('deleteExpenseRecord error:', err);
        showNotification('error', 'Failed to delete expense record');
    }
};

// VACCINATION RECORD HANDLERS
window.editVaccinationRecord = function(index) {
    console.log('editVaccinationRecord called with index:', index);
    const params = new URLSearchParams(window.location.search);
    const pigId = params.get("id");
    const farmId = params.get("farm");
    console.log('pigId:', pigId, 'farmId:', farmId);
    // Try to notify parent via the `recordAction` channel (Farm.js listens on this)
    try {
        window.parent.postMessage({ type: 'recordAction', action: 'openEditVaccinationFromDetails', pigId, farmId, data: { index } }, "*");
        return;
    } catch (postErr) {
        console.warn('postMessage recordAction failed for editVaccination, falling back', postErr);
    }

    // Fallback: direct call if available
    try {
        if (window.parent && typeof window.parent.openEditVaccinationFromDetails === 'function') {
            window.parent.openEditVaccinationFromDetails(pigId, farmId, { index });
            return;
        }
    } catch (directErr) {
        console.warn('Direct call fallback failed for openEditVaccinationFromDetails', directErr);
    }

    // Last resort: use generic callParentAction (openAction channel)
    callParentAction("Edit Vaccination", "openEditVaccinationFromDetails", { index });
};

window.deleteVaccinationRecord = async function(index) {
    console.log('deleteVaccinationRecord called with index:', index);
    const params = new URLSearchParams(window.location.search);
    const pigId = params.get("id");
    const farmId = params.get("farm");

    console.log('pigId:', pigId, 'farmId:', farmId);

    if (!pigId) {
        showNotification('error', 'Pig ID not found');
        return;
    }

    try {
        let pig = null;
        try {
            if (window.parent && typeof window.parent.getPigDataById === 'function') {
                pig = window.parent.getPigDataById(pigId, farmId);
                console.log('Got pig from parent:', pig ? 'yes' : 'no');
            }
        } catch (e) {
            console.warn('Error getting pig from parent:', e);
        }

        // Delegate deletion confirmation to parent — parent knows authoritative records
        try {
            if (window.parent && typeof window.parent.openDeleteRecordConfirmModal === 'function') {
                window.parent.openDeleteRecordConfirmModal('vaccination', pigId, farmId, index);
                return;
            }
        } catch (err) {
            console.warn('Direct call to parent openDeleteRecordConfirmModal failed', err);
        }

        // Fallback: notify parent via openAction channel to open delete modal
        callParentAction("Delete Vaccination", "openDeleteRecordConfirmModal", { type: 'vaccination', index });

    } catch (err) {
        console.warn('deleteVaccinationRecord error:', err);
        showNotification('error', 'Failed to delete vaccination record');
    }
};

// Helper to call parent with optional data
// API helper for weight records - called by parent after form submission
window.submitWeightRecordToAPI = async function(pigId, farmId, weightData, isEdit = false, recordIndex = null) {
    try {
        const candidates = getApiBase();
        let response = null;
        let usedBase = null;

        const pigIdEncoded = encodeURIComponent(pigId);
        
        for (const base of candidates) {
            try {
                let url, method, body;
                
                if (isEdit && recordIndex !== null) {
                    // Get the weight ID - we need this from the parent's data
                    const pig = window.parent?.getPigDataById?.(pigId, farmId);
                    if (!pig?.weightHistory?.[recordIndex]) {
                        console.warn('Could not find weight record to edit');
                        continue;
                    }
                    
                    // For now, use date as identifier if WeightID not available
                    const record = pig.weightHistory[recordIndex];
                    const weightId = record.weightId || `W_${record.date}`;
                    
                    url = `${base.replace(/\/$/, '')}/api/pigs/${pigIdEncoded}/weights/${encodeURIComponent(weightId)}`;
                    method = 'PUT';
                } else {
                    url = `${base.replace(/\/$/, '')}/api/pigs/${pigIdEncoded}/weights`;
                    method = 'POST';
                }

                // Avoid sending full base64 data URLs to the server. If the
                // photoPath looks like a data URL, send null so backend won't
                // attempt to store an oversized string in a VARCHAR column.
                let safePhoto = null;
                try {
                    if (weightData.photoPath && typeof weightData.photoPath === 'string' && !weightData.photoPath.startsWith('data:')) {
                        safePhoto = weightData.photoPath;
                    } else {
                        safePhoto = null;
                    }
                } catch (e) { safePhoto = null; }

                body = {
                    weight: parseFloat(weightData.weight),
                    date: weightData.date,
                    photoPath: safePhoto
                };

                const attempt = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (attempt && attempt.ok) {
                    response = attempt;
                    usedBase = base;
                    break;
                } else {
                    console.debug('API attempt failed:', attempt.status);
                }
            } catch (err) {
                console.debug('API call error:', err.message);
            }
        }

        if (!response) {
            showNotification('error', 'Failed to connect to server');
            return false;
        }

        const result = await response.json();
        if (result.success) {
            showNotification('success', isEdit ? 'Weight record updated successfully!' : 'Weight record added successfully!');
            return true;
        } else {
            showNotification('error', result.message || 'Operation failed');
            return false;
        }
    } catch (err) {
        console.error('submitWeightRecordToAPI error:', err);
        showNotification('error', 'An error occurred');
        return false;
    }
};

// API helper for deleting weight records
window.deleteWeightRecordAPI = async function(pigId, farmId, recordIndex) {
    try {
        const candidates = getApiBase();
        let response = null;

        const pig = window.parent?.getPigDataById?.(pigId, farmId);
        if (!pig?.weightHistory?.[recordIndex]) {
            showNotification('error', 'Weight record not found');
            return false;
        }

        const record = pig.weightHistory[recordIndex];
        const weightId = record.weightId || `W_${record.date}`;
        const pigIdEncoded = encodeURIComponent(pigId);

        for (const base of candidates) {
            try {
                const url = `${base.replace(/\/$/, '')}/api/pigs/${pigIdEncoded}/weights/${encodeURIComponent(weightId)}`;
                
                const attempt = await fetch(url, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (attempt && attempt.ok) {
                    response = attempt;
                    break;
                } else {
                    console.debug('Delete API attempt failed:', attempt.status);
                }
            } catch (err) {
                console.debug('Delete API call error:', err.message);
            }
        }

        if (!response) {
            showNotification('error', 'Failed to connect to server');
            return false;
        }

        const result = await response.json();
        if (result.success) {
            showNotification('success', 'Weight record deleted successfully!');
            return true;
        } else {
            showNotification('error', result.message || 'Deletion failed');
            return false;
        }
    } catch (err) {
        console.error('deleteWeightRecordAPI error:', err);
        showNotification('error', 'An error occurred');
        return false;
    }
};
</script>
<!-- IMAGE VIEWER MODAL -->
<div id="imgViewerModal" class="img-viewer-modal" aria-hidden="true">
    <div class="img-viewer-content" id="imgViewerContent" role="dialog" aria-modal="true">
        <img id="imgViewerImg" class="img-viewer-img" src="" alt="Image preview">
    </div>
</div>

<script>
// Image viewer helpers
function openImageViewer(src) {
    try {
        if (!src) return;
        // Avoid opening blank placeholder svgs
        if (src.startsWith('data:image/svg+xml')) return;

        const modal = document.getElementById('imgViewerModal');
        const imgEl = document.getElementById('imgViewerImg');
        if (!modal || !imgEl) return;

        imgEl.src = src;
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
    } catch (err) { console.warn('openImageViewer error', err); }
}

function closeImageViewer() {
    try {
        const modal = document.getElementById('imgViewerModal');
        const imgEl = document.getElementById('imgViewerImg');
        if (!modal) return;
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        if (imgEl) imgEl.src = '';
    } catch (err) { console.warn('closeImageViewer error', err); }
}

// Close button handler
document.addEventListener('DOMContentLoaded', function () {
    const closeBtn = document.getElementById('imgViewerClose');
    if (closeBtn) closeBtn.addEventListener('click', function (e) { e.stopPropagation(); closeImageViewer(); });

    // Click backdrop to close
    const modal = document.getElementById('imgViewerModal');
    if (modal) modal.addEventListener('click', function (e) {
        if (e.target === modal) closeImageViewer();
    });

    // Escape to close
    document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeImageViewer(); });
});
</script>
</body>
</html>
